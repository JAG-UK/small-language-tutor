<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Tutor</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Main Chat Area -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>Practice Conversation</h2>
                <select id="language-select">
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                </select>
                <button hx-post="/api/save" 
                        hx-vals='{"session_id": "default"}' 
                        hx-headers='{"Content-Type": "application/json"}'
                        hx-target="#save-status"
                        class="save-btn">Save Conversation</button>
                <span id="save-status"></span>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="welcome-message">
                    <p>Start a conversation in your target language! I'll help you practice.</p>
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="text" 
                       id="chat-input" 
                       placeholder="Type your message..."
                       hx-post="/api/chat"
                       hx-trigger="keydown[key=='Enter']"
                       hx-target="#chat-messages"
                       hx-swap="beforeend"
                       hx-vals='{"session_id": "default", "message": "", "language": ""}'
                       hx-include="#language-select"
                       name="message">
                <button id="send-button" onclick="sendMessage()">
                    <span id="send-text">Send</span>
                    <span id="send-spinner" class="spinner" style="display: none;"></span>
                </button>
            </div>
        </div>
        
        <!-- Corrections Panel -->
        <div class="corrections-panel">
            <h3>Learning Points and Hints</h3>
            <div id="corrections-list" 
                 hx-get="/api/corrections?session_id=default"
                 hx-trigger="load, every 2s"
                 hx-swap="innerHTML">
                <p class="empty-state">No corrections yet. Keep practicing!</p>
            </div>
        </div>
        
        <!-- Practice Panel -->
        <div class="practice-panel">
            <h3>Practice Area</h3>
            
            <!-- Top Section: Grammar Check -->
            <div class="practice-section">
                <p class="hint">Test sentences here before sending</p>
                <textarea id="practice-input" 
                          placeholder="Type a sentence to check..."
                          rows="3"></textarea>
                <button onclick="checkPractice()">Check</button>
                <div id="practice-result"></div>
            </div>
            
            <!-- Bottom Section: Translation -->
            <div class="practice-section practice-section-bottom">
                <p class="hint">Translate from English</p>
                <textarea id="translation-input" 
                          placeholder="Enter an English phrase..."
                          rows="3"></textarea>
                <button onclick="translatePhrase()">Translate</button>
                <div id="translation-result"></div>
            </div>
        </div>
    </div>
    
    <script>
        let sessionId = 'default';
        
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const language = document.getElementById('language-select').value;
            const message = input.value.trim();
            const sendButton = document.getElementById('send-button');
            const sendText = document.getElementById('send-text');
            const sendSpinner = document.getElementById('send-spinner');
            
            if (!message) return;
            
            // Disable button and show spinner
            sendButton.disabled = true;
            sendText.style.display = 'none';
            sendSpinner.style.display = 'inline-block';
            input.disabled = true;
            
            fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message,
                    language: language
                })
            })
            .then(r => r.json())
            .then(data => {
                // Add user message
                addMessage('user', message);
                input.value = '';
                
                // Add AI response
                setTimeout(() => addMessage('assistant', data.response), 500);
                
                // Show correction if any
                if (data.correction) {
                    showCorrection(data.correction);
                }
                
                // Refresh corrections
                htmx.trigger('#corrections-list', 'refresh');
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('assistant', 'Sorry, there was an error. Please try again.');
            })
            .finally(() => {
                // Re-enable button and hide spinner
                sendButton.disabled = false;
                sendText.style.display = 'inline';
                sendSpinner.style.display = 'none';
                input.disabled = false;
                input.focus();
            });
        }
        
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            msgDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showCorrection(correction) {
            const correctionsDiv = document.getElementById('corrections-list');
            const correctionDiv = document.createElement('div');
            correctionDiv.className = 'correction-item';
            correctionDiv.innerHTML = `
                <div class="original">${escapeHtml(correction.message || '')}</div>
                <div class="corrected">✓ ${escapeHtml(correction.corrected || '')}</div>
                <div class="explanation">${escapeHtml(correction.explanation || '')}</div>
            `;
            correctionsDiv.insertBefore(correctionDiv, correctionsDiv.firstChild);
        }
        
        function checkPractice() {
            const textarea = document.getElementById('practice-input');
            const language = document.getElementById('language-select').value;
            const sentence = textarea.value.trim();
            
            if (!sentence) return;
            
            fetch('/api/practice', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sentence, language})
            })
            .then(r => r.json())
            .then(data => {
                const resultDiv = document.getElementById('practice-result');
                if (data.has_errors) {
                    resultDiv.innerHTML = `
                        <div class="practice-error">
                            <strong>Correction:</strong> ${escapeHtml(data.corrected)}<br>
                            <em>${escapeHtml(data.explanation)}</em>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="practice-success">
                            ✓ Looks good! Ready to send.
                        </div>
                    `;
                }
            });
        }
        
        function translatePhrase() {
            const textarea = document.getElementById('translation-input');
            const language = document.getElementById('language-select').value;
            const englishPhrase = textarea.value.trim();
            
            if (!englishPhrase) return;
            
            const resultDiv = document.getElementById('translation-result');
            resultDiv.innerHTML = '<div class="practice-loading">Translating...</div>';
            
            fetch('/api/translate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phrase: englishPhrase, language})
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    resultDiv.innerHTML = `
                        <div class="practice-error">
                            ${escapeHtml(data.error)}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="translation-result">
                            <div class="translation-label">Translation:</div>
                            <div class="translation-text">${escapeHtml(data.translation)}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="practice-error">
                        Error: Could not translate. Please try again.
                    </div>
                `;
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Allow Enter to send
        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>

